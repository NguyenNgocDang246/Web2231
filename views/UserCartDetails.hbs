<style>
    /* Căn giữa checkbox trong bảng */
    .checkbox-center {
        text-align: center;
    }
</style>

{{> Nav}}

<!-- Checkout Section -->
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <!-- Order Summary (Product Info) -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title">Order Summary</h2>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th class="checkbox-center">Select to Buy</th>
                                    <th class="checkbox-center">Remove</th>
                                </tr>
                            </thead>
                            <tbody id="orderSummary">
                                <!-- Products will be populated here -->
                                {{#each cartItems}}
                                <tr data-id="{{this._id}}">
                                    <td>{{this.name}}</td>
                                    <td>{{this.quantity}}</td>
                                    <td>{{this.price}}</td>
                                    <td class="checkbox-center"><input type="checkbox" class="product-checkbox"
                                            data-id="{{this._id}}" data-price="{{this.price}}"></td>
                                    <td class="checkbox-center"><button type="button" class="btn btn-danger btn-sm remove-item">Xóa</button></td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                        <h4 class="fw-bold">Total: <span id="totalPrice"></span>đ</h4>
                    </div>
                </div>
            </div>

            <!-- Billing and Payment Information -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title">Billing Information</h2>
                        <form id="paymentForm">
                            <!-- Name -->
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                            <!-- Address -->
                            <div class="mb-3">
                                <label for="address" class="form-label">Shipping Address</label>
                                <input type="text" class="form-control" id="address" required>
                            </div>
                            <!-- Payment Method -->
                            <div class="mb-3">
                                <label for="paymentMethod" class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="creditCard">Online banking</option>
                                    <option value="paypal">Cash payment</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-check-label" for="insuranceCheckbox">
                                    <input type="checkbox" class="form-check-input" id="insuranceCheckbox">
                                    Buy Insurance (1000 VND)
                                </label>
                            </div>
                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-success w-100">Confirm Purchase</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{{> Footer}}

<script>
    $(document).ready(function () {
        // Function to populate order summary dynamically
        function populateOrderSummary() {
            let totalPrice = 0;

            // Lặp qua các dòng trong bảng và tính tổng giá trị các sản phẩm được chọn
            $('#orderSummary tr').each(function () {
                const checkbox = $(this).find('.product-checkbox');
                if (checkbox.prop('checked')) {
                    const price = parseFloat(checkbox.data('price')); // Lấy giá từ data-price
                    const quantity = parseInt($(this).find('td:nth-child(2)').text()); // Lấy số lượng từ cột 2
                    totalPrice += price * quantity; // Cộng giá trị vào tổng
                }
            });

            // Cập nhật tổng giá trị
            $('#totalPrice').text(totalPrice);
        }

        // Event listener for checkbox change
        $('#orderSummary').on('change', '.product-checkbox', function () {
            populateOrderSummary(); // Recalculate total price khi checkbox thay đổi
        });

        // Handle item removal
        $('#orderSummary').on('click', '.remove-item', function () {
            const itemId = $(this).closest('tr').data('id');  // Lấy id của item muốn xóa

            // Gửi AJAX request để xóa item
            $.ajax({
                url: '/cart/remove', // URL xử lý xóa item
                method: 'POST',
                data: { productId: itemId },
                success: function (response) {
                    // Xóa item khỏi bảng
                    $(`[data-id=${itemId}]`).remove();
                    populateOrderSummary();  // Recalculate total price sau khi xóa
                },
                error: function () {
                    alert('Failed to remove item.');
                }
            });
        });

        // Handle form submission
        $('#paymentForm').on('submit', function (event) {
            event.preventDefault();  // Prevent form from submitting

            // Lấy tất cả các sản phẩm đã chọn
            const selectedItems = [];
            $('#orderSummary tr').each(function () {
                const checkbox = $(this).find('.product-checkbox');
                if (checkbox.prop('checked')) {
                    const productId = checkbox.data('id');
                    const quantity = parseInt($(this).find('td:nth-child(2)').text());
                    const price = parseFloat(checkbox.data('price'));

                    selectedItems.push({ productId, quantity, price });
                }
            });

            // Lấy thông tin thanh toán từ form
            const fullName = $('#fullName').val();
            const address = $('#address').val();
            const paymentMethod = $('#paymentMethod').val();
            const insurance = $('#insuranceCheckbox').prop('checked') ? true : false;

            // Gửi dữ liệu thanh toán và giỏ hàng đã chọn tới server
            $.ajax({
                url: '/checkout/confirm',  // URL xử lý thanh toán
                method: 'POST',
                data: {
                    selectedItems: selectedItems,
                    fullName: fullName,
                    address: address,
                    paymentMethod: paymentMethod,
                    insurance: insurance
                },
                success: function (response) {
                    alert('Thank you for your purchase! Your order has been confirmed.');
                    // Redirect hoặc xử lý kết quả
                },
                error: function () {
                    alert('Failed to confirm purchase.');
                }
            });
        });

        // Initial population of the order summary
        populateOrderSummary();  // Khởi tạo giỏ hàng khi tải trang
    });
</script>
